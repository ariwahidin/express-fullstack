<link rel="stylesheet" href="<%= baseUrl%>/desktop/vendor/css/pages/app-logistics-fleet.css" />
<!-- <script src="<%= baseUrl%>/desktop/vendor/libs/jquery/jquery.js"></script> -->


<!-- Map link -->
<link rel="stylesheet" type="text/css" href="<%=baseUrl%>/assets/css/leaflet.css">
<script src="<%=baseUrl%>/assets/js/leaflet.js"></script>

<button class="btn btn-primary btn-sm" id="refresh-btn">Refresh</button>
<div class="card overflow-hidden">
    <!-- Map Menu Wrapper -->
    <div class="d-flex app-logistics-fleet-wrapper">

        <!-- Map Menu Button when screen is < md -->
        <div class="flex-shrink-0 position-fixed m-6 d-md-none w-auto z-1">
            <button class="btn btn-white btn-white-dark-variant z-2 p-2 waves-effect waves-light"
                data-bs-toggle="sidebar" data-overlay="" data-target="#app-logistics-fleet-sidebar"><i
                    class="ti ti-menu-2 ti-md"></i></button>
        </div>

        <ul id="armada-list"></ul>

        <!-- Map Menu -->
        <div class="app-logistics-fleet-sidebar col h-100 show" id="app-logistics-fleet-sidebar">
            <div class="card-header border-0 pt-6 pb-1 d-flex justify-content-between">
                <h5 class="mb-0 card-title">Armada</h5>
                <!-- Sidebar close button -->
                <i class="ti ti-x ti-xs cursor-pointer close-sidebar d-md-none btn btn-sm btn-icon btn-text-secondary rounded-pill p-0 waves-effect waves-light"
                    data-bs-toggle="sidebar" data-overlay="" data-target="#app-logistics-fleet-sidebar"></i>
            </div>
            <!-- Sidebar when screen < md -->
            <!-- <div id="listArmada"></div> -->
            <div class="card-body p-0 logistics-fleet-sidebar-body ps ps--active-y">
                <div class="accordion py-2 px-1" id="fleet" data-bs-toggle="sidebar" data-overlay=""
                    data-target="#app-logistics-fleet-sidebar">
                    <div class="accordion-item border-0 mb-0 shadow-none" id="fl-1">
                        <div class="accordion-header" id="fleetOne">
                            <div role="button" class="accordion-button shadow-none align-items-center collapsed"
                                data-bs-toggle="collapse" data-bs-target="#fleet1" aria-expanded="false"
                                aria-controls="fleet1">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-wrapper">
                                        <div class="avatar me-4">
                                            <span class="avatar-initial rounded-circle bg-label-secondary"><i
                                                    class="ti ti-car ti-lg"></i></span>
                                        </div>
                                    </div>
                                    <span class="d-flex flex-column gap-1">
                                        <span class="text-heading">VOLT-342808</span>
                                        <span class="text-body">Chelsea, NY, USA</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div id="fleet1" class="accordion-collapse collapse" data-bs-parent="#fleet">
                            <div class="accordion-body pt-4 pb-0">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h6 class="fw-normal mb-1">Delivery Process</h6>
                                    <p class="text-body mb-1">88%</p>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 88%;" aria-valuenow="88"
                                        aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <ul class="timeline ps-4 mt-6">
                                    <li class="timeline-item ps-6 pb-3 border-left-dashed">
                                        <span
                                            class="timeline-indicator-advanced timeline-indicator-success border-0 shadow-none">
                                            <i class="ti ti-circle-check"></i>
                                        </span>
                                        <div class="timeline-event ps-0 pb-0">
                                            <div class="timeline-header">
                                                <small class="text-success text-uppercase">tracking number
                                                    created</small>
                                            </div>
                                            <h6 class="my-50">Veronica Herman</h6>
                                            <small class="text-body">Sep 01, 7:53 AM</small>
                                        </div>
                                    </li>
                                    <li class="timeline-item ps-6 pb-3 border-left-dashed">
                                        <span
                                            class="timeline-indicator-advanced timeline-indicator-success border-0 shadow-none">
                                            <i class="ti ti-circle-check"></i>
                                        </span>
                                        <div class="timeline-event ps-0 pb-0">
                                            <div class="timeline-header">
                                                <small class="text-success text-uppercase">out for delivery</small>
                                            </div>
                                            <h6 class="my-50">Veronica Herman</h6>
                                            <small class="text-body">Sep 03, 8:02 AM</small>
                                        </div>
                                    </li>
                                    <li class="timeline-item ps-6 border-transparent">
                                        <span
                                            class="timeline-indicator-advanced timeline-indicator-primary border-0 shadow-none">
                                            <i class="ti ti-map-pin mt-1"></i>
                                        </span>
                                        <div class="timeline-event ps-0 pb-0">
                                            <div class="timeline-header">
                                                <small class="text-primary text-uppercase fw-medium">arriving</small>
                                            </div>
                                            <h6 class="my-50">Veronica Herman</h6>
                                            <small class="text-body">Sep 04, 8:18 AM</small>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <div class="ps__rail-x" style="left: 0px; bottom: 0px;">
                    <div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                </div>
                <div class="ps__rail-y" style="top: 0px; height: 388px; right: 0px;">
                    <div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 228px;"></div>
                </div> -->
            </div>
        </div>

        <!-- Mapbox Map container -->
        <div class="col h-100 map-container">
            <!-- Map -->
            <div id="map" class="h-100 w-100">

            </div>
        </div>

        <!-- Overlay Hidden -->
        <div class="app-overlay d-none show"></div>
    </div>
</div>
<script src="<%= baseUrl%>/desktop/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>

<!-- <script src="<%= baseUrl%>/desktop/vendor/libs/i18n/i18n.js"></script> -->

<!-- Vendors JS -->
<!-- <script src="<%= baseUrl%>/desktop/vendor/libs/mapbox-gl/mapbox-gl.js"></script> -->
<!-- Page JS -->
<script src="<%= baseUrl%>/desktop/js/app-logistics-fleet.js"></script>
<script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
<script>
    $(document).ready(function () {
        const socket = io('<%=baseUrl%>', {
            path: '/py-express/socket.io' // Sesuaikan dengan path socket.io yang Anda atur di server
        });
        // Inisialisasi peta
        var map = L.map('map').setView([-6.200000, 106.816666], 10);



        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);


        getStatusArmada();
        function getStatusArmada() {
            const url = "<%= baseUrl%>/desktop/armada/getStatusArmada";
            $.post(url, {}, function (response) {


                // Konfigurasi ikon truk
                var truckIcon = L.icon({
                    iconUrl: "<%= baseUrl%>/assets/images/app_icon/icon-512x512.png", // Ganti dengan URL ikon truk
                    iconSize: [52, 52], // Ukuran ikon
                    iconAnchor: [16, 32], // Titik tengah ikon
                    popupAnchor: [0, -32] // Titik popup di atas ikon
                });


                let armadas = response.data;

                let listArmada = $('#fleet');
                listArmada.empty();
                // Tambahkan marker ke peta dan list ke DOM
                armadas.forEach(function (armada) {
                    var popupContent = '<b>' + armada.order_id + '</b><br>' + armada.address;
                    L.marker([armada.lat, armada.lon], { icon: truckIcon }).addTo(map).bindPopup(popupContent);

                    let elemList = `<div class="accordion-item border-0 mb-0 shadow-none" id="fl-${armada.id}">
                                        <div class="accordion-header" id="fleetOne-${armada.id}">
                                            <div role="button" class="accordion-button shadow-none align-items-center collapsed"
                                                data-bs-toggle="collapse" data-bs-target="#fleet1-${armada.id}" aria-expanded="false"
                                                aria-controls="fleet1">
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-wrapper">
                                                        <div class="avatar me-4">
                                                            <span class="avatar-initial rounded-circle bg-label-secondary"><i
                                                                    class="ti ti-truck ti-lg"></i></span>
                                                        </div>
                                                    </div>
                                                    <span class="d-flex flex-column gap-1">
                                                        <span class="text-heading spanArmada" data-lat="${armada.lat}" data-lon="${armada.lon}" >${armada.order_id}</span>
                                                        <span class="text-body">${armada.truck_no}, ${armada.driver_name}</span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="fleet1-${armada.id}" class="accordion-collapse collapse" data-bs-parent="#fleet">
                                            <div class="accordion-body pt-4 pb-0">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <h6 class="fw-normal mb-1">Delivery Process</h6>
                                                    <p class="text-body mb-1">88%</p>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" style="width: 88%;" aria-valuenow="88"
                                                        aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                                <ul class="timeline ps-4 mt-6">
                                                    <li class="timeline-item ps-6 pb-3 border-left-dashed">
                                                        <span
                                                            class="timeline-indicator-advanced timeline-indicator-success border-0 shadow-none">
                                                            <i class="ti ti-circle-check"></i>
                                                        </span>
                                                        <div class="timeline-event ps-0 pb-0">
                                                            <div class="timeline-header">
                                                                <small class="text-success text-uppercase">tracking number
                                                                    created</small>
                                                            </div>
                                                            <h6 class="my-50">Veronica Herman</h6>
                                                            <small class="text-body">Sep 01, 7:53 AM</small>
                                                        </div>
                                                    </li>
                                                    <li class="timeline-item ps-6 pb-3 border-left-dashed">
                                                        <span
                                                            class="timeline-indicator-advanced timeline-indicator-success border-0 shadow-none">
                                                            <i class="ti ti-circle-check"></i>
                                                        </span>
                                                        <div class="timeline-event ps-0 pb-0">
                                                            <div class="timeline-header">
                                                                <small class="text-success text-uppercase">out for delivery</small>
                                                            </div>
                                                            <h6 class="my-50">Veronica Herman</h6>
                                                            <small class="text-body">Sep 03, 8:02 AM</small>
                                                        </div>
                                                    </li>
                                                    <li class="timeline-item ps-6 border-transparent">
                                                        <span
                                                            class="timeline-indicator-advanced timeline-indicator-primary border-0 shadow-none">
                                                            <i class="ti ti-map-pin mt-1"></i>
                                                        </span>
                                                        <div class="timeline-event ps-0 pb-0">
                                                            <div class="timeline-header">
                                                                <small class="text-primary text-uppercase fw-medium">arriving</small>
                                                            </div>
                                                            <h6 class="my-50">Veronica Herman</h6>
                                                            <small class="text-body">Sep 04, 8:18 AM</small>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>`;

                    console.log('test');
                    listArmada.append(elemList);

                    // listArmada.append('<li data-lat="' + armada.lat + '" data-lon="' + armada.lon + '">' + armada.order_id + '</li>');
                });

                // Tambahkan event click pada list
                $('#fleet').on('click', '.spanArmada', function () {
                    var lat = $(this).data('lat');
                    var lon = $(this).data('lon');
                    map.setView([lat, lon], 15);
                });
            }, "JSON");
        }

        $('#refresh-btn').on('click', function () {
            getStatusArmada();
        });

        socket.on('updateArmadas', function () {
            getStatusArmada();
        });

    });
</script>